<!DOCTYPE html>

<html>
  <head>
    <title>Fjongdenger</title>
    <style>
      body {
        background-color: powderblue;
        font-size: 20px;
      }
      th,
      td {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Major DKP</th>
          <th>Minor DKP</th>
          <th>Activity</th>
          <th>Attendance</th>
          <th>Majors looted</th>
          <th>Minors looted</th>
          <th>Last Major</th>
          <th>Last Minor</th>
          <th>Kills since last Major</th>
          <th>Kills since last Minor</th>
        </tr>
      </thead>
      <tbody id="users"></tbody>
    </table>

    <h1 style="color:blueviolet;">DKP Weights</h1>
    <pre id="dkp_weights" style="color:blueviolet; font-weight: bold;"></pre>

    <h1>Requests</h1>
    <div id="requests" />

    <script type="text/javascript">
      let fetchData = () => {
        fetch(
          "https://kbf0hkyvyg.execute-api.eu-central-1.amazonaws.com/dev/hgdata"
        )
          .then(response => response.json())
          .then(data => {
            const items = Object.keys(data.items).map(key => data.items[key]);
            const users = Object.keys(data.users).map(key => data.users[key]);

            calculateDKP(data.dkp.minor, data);
            calculateDKP(data.dkp.major, data);

            Object.keys(data.requests.item)
              .map(key => data.requests.item[key])
              .forEach(requests => {
                const itemId = Object.keys(requests).map(
                  key => requests[key]
                )[0].item_id;
                const userRequests = Object.keys(requests)
                  .map(key => requests[key])
                  .filter(
                    userRequest =>
                      users.find(u => u.id === userRequest.user_id).rank !==
                      "none"
                  )
                  .map(userRequest => {
                    const user = users.find(u => u.id === userRequest.user_id);
                    const dkp = data.dkp[userRequest.request_type].find(
                      dkps => dkps.user_id === userRequest.user_id
                    );
                    return user.name
                      .concat(" (" + userRequest.request_type + ")")
                      .concat(dkp ? " dkp: " + dkp.dkp : "");
                  })
                  .join(", ");
                var itemName = document.createTextNode(
                  items.find(_item => _item.id === itemId).name
                );

                var div = document.createElement("div");
                var h3 = document.createElement("h3");
                var p = document.createElement("p");

                p.appendChild(document.createTextNode(userRequests));
                h3.appendChild(itemName);
                div.appendChild(h3);
                div.appendChild(p);
                document.getElementById("requests").appendChild(div);
              });

            Object.keys(data.users)
              .map(key => data.users[key])
              .filter(user => user.rank !== "none")
              .sort((a, b) => {
                return (
                  getMajorDkp(data, b.id).dkp - getMajorDkp(data, a.id).dkp
                );
              })
              .forEach(user => {
                const minor = getMinorDkp(data, user.id);
                const major = getMajorDkp(data, user.id);

                const newRow = document.getElementById("users").insertRow();

                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(user.name));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.dkp));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(minor.dkp));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.activity));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.attendance));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.loot));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(minor.loot));
                newRow
                  .insertCell()
                  .appendChild(
                    document.createTextNode(
                      new Date(major.last_loot).toDateString()
                    )
                  );
                newRow
                  .insertCell()
                  .appendChild(
                    document.createTextNode(
                      new Date(minor.last_loot).toDateString()
                    )
                  );
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.kills_since_loot));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(minor.kills_since_loot));

                document.getElementById(
                  "dkp_weights"
                ).innerHTML = JSON.stringify(data.dkp_weights, undefined, 2);
              });
          });
      };

      const getMinorDkp = (data, userId) => {
        return (
          data.dkp.minor.find(m => m.user_id == userId) || {
            activity: "",
            attendance: ""
          }
        );
      };

      const getMajorDkp = (data, userId) => {
        return (
          data.dkp.major.find(m => m.user_id == userId) || {
            activity: "",
            attendance: ""
          }
        );
      };

      const calculateDKP = (array, data) => {
        array.forEach(function(item, key) {
          const ratioScore = Math.min(
            calculateRatioScore(item.attendance, item.loot) *
              data.dkp_weights.ratio_multiplier,
            data.dkp_weights.ratio_cap
          );
          const raidScore = Math.min(
            item.attendance * data.dkp_weights.total_raids_multiplier,
            data.dkp_weights.total_raids_cap
          );
          const activityScore = Math.min(
            item.activity * 100 * data.dkp_weights.activity_multiplier,
            data.dkp_weights.activity_cap
          );
          const rslScore = Math.min(
            item.kills_since_loot *
              data.dkp_weights.raids_since_loot_multiplier,
            data.dkp_weights.raids_since_loot_cap
          );
          item.dkp = (
            raidScore +
            ratioScore +
            rslScore * activityScore
          ).toFixed(2);
        });
      };

      function calculateRatioScore(raids, loot) {
        if (loot === 0) {
          loot = 1;
          raids *= 2;
        }
        return raids / loot;
      }

      fetchData();
    </script>
  </body>
</html>
