<!DOCTYPE html>

<html>
  <head>
    <title>Fjongdenger</title>
    <style>
      body {
        background-color: powderblue;
        font-size: 20px;
      }
      th,
      td {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Activity</th>
          <th>Attendance</th>
          <th>Majors looted</th>
          <th>Minors looted</th>
          <th>Last Major</th>
          <th>Last Minor</th>
          <th>Kills since last Major</th>
          <th>Kills since last Minor</th>
        </tr>
      </thead>
      <tbody id="users"></tbody>
    </table>

    <h1 style="color:blueviolet;">DKP Weights</h1>
    <pre id="dkp_weights" style="color:blueviolet; font-weight: bold;"></pre>

    <h1>Requests</h1>
    <div id="requests" />

    <script type="text/javascript">
      let fetchData = () => {
        fetch(
          'https://kbf0hkyvyg.execute-api.eu-central-1.amazonaws.com/dev/hgdata'
        )
          .then(response => response.json())
          .then(data => {
            const items = Object.keys(data.items).map(key => data.items[key]);
            const users = Object.keys(data.users).map(key => data.users[key]);

            Object.keys(data.requests.item)
              .map(key => data.requests.item[key])
              .forEach(requests => {
                const itemId = Object.keys(requests).map(
                  key => requests[key]
                )[0].item_id;
                const userRequests = Object.keys(requests)
                  .map(key => requests[key])
                  .map(userRequest => {
                    const user = users.find(u => u.id === userRequest.user_id);
                    return user.name.concat(
                      ' (' + userRequest.request_type + ')'
                    );
                  })
                  .join(', ');
                var itemName = document.createTextNode(
                  items.find(_item => _item.id === itemId).name
                );

                var div = document.createElement('div');
                var h3 = document.createElement('h3');
                var p = document.createElement('p');

                p.appendChild(document.createTextNode(userRequests));
                h3.appendChild(itemName);
                div.appendChild(h3);
                div.appendChild(p);
                document.getElementById('requests').appendChild(div);
              });

            Object.keys(data.users)
              .map(key => data.users[key])
              .forEach(user => {
                const minor = data.dkp.minor.find(
                  m => m.user_id == user.id
                ) || {
                  activity: '',
                  attendance: ''
                };
                const major = data.dkp.major.find(
                  m => m.user_id == user.id
                ) || {
                  activity: '',
                  attendance: ''
                };

                const newRow = document.getElementById('users').insertRow();

                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(user.name));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.activity));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.attendance));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.loot));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(minor.loot));
                newRow
                  .insertCell()
                  .appendChild(
                    document.createTextNode(
                      new Date(major.last_loot).toDateString()
                    )
                  );
                newRow
                  .insertCell()
                  .appendChild(
                    document.createTextNode(
                      new Date(minor.last_loot).toDateString()
                    )
                  );
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(major.kills_since_loot));
                newRow
                  .insertCell()
                  .appendChild(document.createTextNode(minor.kills_since_loot));

                document.getElementById(
                  'dkp_weights'
                ).innerHTML = JSON.stringify(data.dkp_weights, undefined, 2);
              });
          });
      };

      fetchData();
    </script>
  </body>
</html>
